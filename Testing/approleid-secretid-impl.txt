

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault read auth/new-app/dev/role/new-app-read/role-id
Key        Value
---        -----
role_id    b173d642-288b-63ec-0dc1-ffc78073d971
manivelsubramaniyan@Manivels-MacBook-Air ~ % 

---------------------------------------------------------------------------------------------

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault write -f auth/new-app/dev/role/new-app-read/secret-id
Key                   Value
---                   -----
secret_id             11f91feb-1e28-ff0e-a321-0c4f5c7e7e7d
secret_id_accessor    0e1fe273-e4f2-eaf5-c307-43cf0b72540b
secret_id_ttl         0s

---------------------------------------------------------------------------------------------

spring.cloud.vault:
  application-name: new-app
  enabled: true
  authentication: APPROLE
  uri: http://localhost:8200
  app-role:
    role-id: b173d642-288b-63ec-0dc1-ffc78073d971
    secret-id: 1930c67c-ea10-dde3-3a29-63fcffd76f0b
    role: new-app-read
    app-role-path: new-app/dev
  kv:
    enabled: true
    backend: kv
---------------------------------------------------------------------------------------------
Secrets:
/secret/new-app/dev
{
  "db-pw": "vault-new-app-db-pw-dev",
  "db-uname": "vault-new-app-db-name-dev"
}

Authentication Methods:
new-app/dev

Type 			approle
Path			new-app/dev/
Accessor 		auth_approle_573cfaaa
Local 			No
Seal wrap		No
Default Lease 	TTL 0
Max Lease TTL 	0
Token Type 		default-service
---------------------------------------------------------------------------------------------

package configserver.valutwithmongo.configuration;

import java.util.Arrays;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.config.server.environment.CompositeEnvironmentRepository;
import org.springframework.cloud.config.server.environment.VaultEnvironmentProperties;
import org.springframework.cloud.config.server.environment.vault.SpringVaultEnvironmentRepository;
import org.springframework.cloud.config.server.environment.vault.SpringVaultEnvironmentRepositoryFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.core.Ordered;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.vault.core.VaultKeyValueOperations;

@Configuration
public class CompositeEnvironmentRepositoryConfiguration {

    @Autowired
    private MongoTemplate mongoTemplate;

    @Autowired
    private SpringVaultEnvironmentRepositoryFactory vaultEnvironmentRepositoryFactory;

//    @Value("${spring.cloud.config.server.vault.token}")
//    private String vaultToken;
//
//    @Value("${spring.cloud.config.server.vault.token2}")
//    private String vaultToken2;

    SpringVaultEnvironmentRepository vaultRepoObjectToWrite;
    SpringVaultEnvironmentRepository vaultRepoObjectToRead;
    SpringVaultEnvironmentRepository newVaultReadRepo;

    @Bean
    @Primary
    public CompositeEnvironmentRepository compositeEnvironmentRepository() {

        //MongoRepository object to read properties from mongoDB
        MongoEnvironmentRepository mongoEnvironmentRepository = new MongoEnvironmentRepository(Ordered.LOWEST_PRECEDENCE, mongoTemplate);


        VaultEnvironmentProperties readProps = new VaultEnvironmentProperties();
//        readProps.setAuthentication(VaultEnvironmentProperties.AuthenticationMethod.APPROLE);
//        readProps.getAppRole().setRole("myapp-read");
//        readProps.getAppRole().setAppRolePath("new-app/dev");
//        readProps.getAppRole().setRoleId("ac7fdff3-b3b8-b19f-86bd-005a486640b3");
//        readProps.getAppRole().setSecretId("7dacff87-be0a-4c9a-2da3-754b024f410a");
        this.newVaultReadRepo = vaultEnvironmentRepositoryFactory
                .build(readProps);

        return new CompositeEnvironmentRepository(Arrays.asList(mongoEnvironmentRepository, newVaultReadRepo),
                false);
    }


    private VaultEnvironmentProperties setVaultEnvironmentProperties(String profileSeparator, int kvVersion, String vaultToken) {
        VaultEnvironmentProperties properties = new VaultEnvironmentProperties();
        properties.setProfileSeparator(profileSeparator);
        properties.setKvVersion(kvVersion);
        properties.setToken(vaultToken);
        return properties;
    }

    public SpringVaultEnvironmentRepository getVaultRepoObjectToWrite() {
        return vaultRepoObjectToWrite;
    }


    public SpringVaultEnvironmentRepository getVaultRepoObjectToRead() {
        return vaultRepoObjectToRead;
    }

}
------------------------------------------------------------------------------------------------------
bootstrap.yaml

spring.cloud.vault:
  application-name: new-app
  enabled: true
  authentication: APPROLE
  uri: http://localhost:8200
  app-role:
    role-id: b173d642-288b-63ec-0dc1-ffc78073d971
    secret-id: 1930c67c-ea10-dde3-3a29-63fcffd76f0b
    role: new-app-read
    app-role-path: new-app/dev
  kv:
    enabled: true
    backend: kv
------------------------------------------------------------------------------------------------------
postman;
http://localhost:8082/new-app/dev

Response:
{
    "name": "new-app",
    "profiles": [
        "dev"
    ],
    "label": null,
    "version": null,
    "state": null,
    "propertySources": []
}


Error Log:
 Cannot enhance VaultToken to a LoginToken: Token self-lookup failed: 403 permission denied
 
 Error adding environment for 
 org.springframework.cloud.config.server.environment.vault.SpringVaultEnvironmentRepository@50c24b0e
 ------------------------------------------------------------------------------------------------------