

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault read auth/new-app/dev/role/new-app-read/role-id
Key        Value
---        -----
role_id    b173d642-288b-63ec-0dc1-ffc78073d971
manivelsubramaniyan@Manivels-MacBook-Air ~ % 

---------------------------------------------------------------------------------------------

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault write -f auth/new-app/dev/role/new-app-read/secret-id
Key                   Value
---                   -----
secret_id             11f91feb-1e28-ff0e-a321-0c4f5c7e7e7d
secret_id_accessor    0e1fe273-e4f2-eaf5-c307-43cf0b72540b
secret_id_ttl         0s

---------------------------------------------------------------------------------------------

spring.cloud.vault:
  application-name: new-app
  enabled: true
  authentication: APPROLE
  uri: http://localhost:8200
  app-role:
    role-id: b173d642-288b-63ec-0dc1-ffc78073d971
    secret-id: 1930c67c-ea10-dde3-3a29-63fcffd76f0b
    role: new-app-read
    app-role-path: new-app/dev
  kv:
    enabled: true
    backend: kv
---------------------------------------------------------------------------------------------
Secrets:
/secret/new-app/dev
{
  "db-pw": "vault-new-app-db-pw-dev",
  "db-uname": "vault-new-app-db-name-dev"
}

Authentication Methods:
new-app/dev

Type 			approle
Path			new-app/dev/
Accessor 		auth_approle_573cfaaa
Local 			No
Seal wrap		No
Default Lease 	TTL 0
Max Lease TTL 	0
Token Type 		default-service
---------------------------------------------------------------------------------------------

package configserver.valutwithmongo.configuration;

import java.util.Arrays;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.config.server.environment.CompositeEnvironmentRepository;
import org.springframework.cloud.config.server.environment.VaultEnvironmentProperties;
import org.springframework.cloud.config.server.environment.vault.SpringVaultEnvironmentRepository;
import org.springframework.cloud.config.server.environment.vault.SpringVaultEnvironmentRepositoryFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.core.Ordered;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.vault.core.VaultKeyValueOperations;

@Configuration
public class CompositeEnvironmentRepositoryConfiguration {

    @Autowired
    private MongoTemplate mongoTemplate;

    @Autowired
    private SpringVaultEnvironmentRepositoryFactory vaultEnvironmentRepositoryFactory;

//    @Value("${spring.cloud.config.server.vault.token}")
//    private String vaultToken;
//
//    @Value("${spring.cloud.config.server.vault.token2}")
//    private String vaultToken2;

    SpringVaultEnvironmentRepository vaultRepoObjectToWrite;
    SpringVaultEnvironmentRepository vaultRepoObjectToRead;
    SpringVaultEnvironmentRepository newVaultReadRepo;

    @Bean
    @Primary
    public CompositeEnvironmentRepository compositeEnvironmentRepository() {

        //MongoRepository object to read properties from mongoDB
        MongoEnvironmentRepository mongoEnvironmentRepository = new MongoEnvironmentRepository(Ordered.LOWEST_PRECEDENCE, mongoTemplate);


        VaultEnvironmentProperties readProps = new VaultEnvironmentProperties();
//        readProps.setAuthentication(VaultEnvironmentProperties.AuthenticationMethod.APPROLE);
//        readProps.getAppRole().setRole("myapp-read");
//        readProps.getAppRole().setAppRolePath("new-app/dev");
//        readProps.getAppRole().setRoleId("ac7fdff3-b3b8-b19f-86bd-005a486640b3");
//        readProps.getAppRole().setSecretId("7dacff87-be0a-4c9a-2da3-754b024f410a");
        this.newVaultReadRepo = vaultEnvironmentRepositoryFactory
                .build(readProps);

        return new CompositeEnvironmentRepository(Arrays.asList(mongoEnvironmentRepository, newVaultReadRepo),
                false);
    }


    private VaultEnvironmentProperties setVaultEnvironmentProperties(String profileSeparator, int kvVersion, String vaultToken) {
        VaultEnvironmentProperties properties = new VaultEnvironmentProperties();
        properties.setProfileSeparator(profileSeparator);
        properties.setKvVersion(kvVersion);
        properties.setToken(vaultToken);
        return properties;
    }

    public SpringVaultEnvironmentRepository getVaultRepoObjectToWrite() {
        return vaultRepoObjectToWrite;
    }


    public SpringVaultEnvironmentRepository getVaultRepoObjectToRead() {
        return vaultRepoObjectToRead;
    }

}
------------------------------------------------------------------------------------------------------
bootstrap.yaml

spring.cloud.vault:
  application-name: new-app
  enabled: true
  authentication: APPROLE
  uri: http://localhost:8200
  app-role:
    role-id: b173d642-288b-63ec-0dc1-ffc78073d971
    secret-id: 1930c67c-ea10-dde3-3a29-63fcffd76f0b
    role: new-app-read
    app-role-path: new-app/dev
  kv:
    enabled: true
    backend: kv
------------------------------------------------------------------------------------------------------
postman;
http://localhost:8082/new-app/dev

Response:
{
    "name": "new-app",
    "profiles": [
        "dev"
    ],
    "label": null,
    "version": null,
    "state": null,
    "propertySources": []
}


Error Log:
 Cannot enhance VaultToken to a LoginToken: Token self-lookup failed: 403 permission denied
 
 Error adding environment for 
 org.springframework.cloud.config.server.environment.vault.SpringVaultEnvironmentRepository@50c24b0e
 ------------------------------------------------------------------------------------------------------
 
 After the meeting : 05/04
 
Creating secret:
 
manivelsubramaniyan@Manivels-MacBook-Air ~ % export VAULT_ADDR=http://127.0.0.1:8200                                     
manivelsubramaniyan@Manivels-MacBook-Air ~ % export VAULT_TOKEN=root

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault kv put secret/mysql/webapp db_name="users" username="admin" password="passw0rd"
====== Secret Path ======
secret/data/mysql/webapp

======= Metadata =======
Key                Value
---                -----
created_time       2022-05-04T20:33:56.093131Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
--------------------------------------------------------------------------------------------------------------
Enable the approle:

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault auth enable approle
Success! Enabled approle auth method at: approle/

--------------------------------------------------------------------------------------------------------------

Setting up the policy:

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault policy write jenkins -<<EOF
# Read-only permission on secrets stored at 'secret/data/mysql/webapp'
path "secret/data/mysql/webapp" {
  capabilities = [ "read" ]
}
EOF

Success! Uploaded policy: jenkins

--------------------------------------------------------------------------------------------------------------

Create role:

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault write auth/approle/role/jenkins token_policies="jenkins" \
    token_ttl=1h token_max_ttl=4h

Success! Data written to: auth/approle/role/jenkins

--------------------------------------------------------------------------------------------------------------

Verify the role:

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault read auth/approle/role/jenkins
Key                        Value
---                        -----
bind_secret_id             true
local_secret_ids           false
secret_id_bound_cidrs      <nil>
secret_id_num_uses         0
secret_id_ttl              0s
token_bound_cidrs          []
token_explicit_max_ttl     0s
token_max_ttl              4h
token_no_default_policy    false
token_num_uses             0
token_period               0s
token_policies             [jenkins]
token_ttl                  1h
token_type                 default
--------------------------------------------------------------------------------------------------------------

manivelsubramaniyan@Manivels-MacBook-Air ~ % vault read auth/approle/role/jenkins/role-id
Key        Value
---        -----
role_id    e18c76f3-5d18-49d1-2d41-2dcbf9327249


manivelsubramaniyan@Manivels-MacBook-Air ~ % vault write -force auth/approle/role/jenkins/secret-id
Key                   Value
---                   -----
secret_id             602568f3-4c52-c35e-cc62-46a462b3d77a
secret_id_accessor    f582e887-aba9-f5c1-a1c5-f41c9c44ad2f
secret_id_ttl         0s

--------------------------------------------------------------------------------------------------------------
login:
manivelsubramaniyan@Manivels-MacBook-Air ~ % vault write auth/approle/login role_id="e18c76f3-5d18-49d1-2d41-2dcbf9327249" \                                                  
    secret_id="602568f3-4c52-c35e-cc62-46a462b3d77a"

Key                     Value
---                     -----
token                   hvs.CAESIGzJxbT6b7z4e8X23rGRyOo7Wsomfcw0bwXXG1PXBHJkGh4KHGh2cy5tU21raEpUY0M2cGdESHU1NTVSclJxMTM
token_accessor          3RXH5y1cmkgTOqcAYrGSLoby
token_duration          1h
token_renewable         true
token_policies          ["default" "jenkins"]
identity_policies       []
policies                ["default" "jenkins"]
token_meta_role_name    jenkins
--------------------------------------------------------------------------------------------------------------
manivelsubramaniyan@Manivels-MacBook-Air ~ % export APP_TOKEN="hvs.CAESIGzJxbT6b7z4e8X23rGRyOo7Wsomfcw0bwXXG1PXBHJkGh4KHGh2cy5tU21raEpUY0M2cGdESHU1NTVSclJxMTM"
manivelsubramaniyan@Manivels-MacBook-Air ~ % VAULT_TOKEN=$APP_TOKEN vault kv get secret/mysql/webapp
====== Secret Path ======
secret/data/mysql/webapp

======= Metadata =======
Key                Value
---                -----
created_time       2022-05-04T20:33:56.093131Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
db_name     users
password    passw0rd
username    admin
--------------------------------------------------------------------------------------------------------------